MODULE AR_ASY_FU
implicit none
 PRIVATE
 PUBLIC asy_smooth_rough, ir_small_large
 
!---------------------------------------------------------
! 	dimension cs(3,6), dc(2,6), ps(3,6), dp(2,6)
	real,save, dimension(3,6) :: cs,ps , cr,pr
	real,save, dimension(2,6) :: dc,dp
	real,save, dimension(4,6) :: bps,cps,dps
! ********************************************************
! Coefficients for the asymmetry factor of ice column
! particles (AR <= 1.0) with SMOOTH (cs) surfaces and 
! for their delta-transmission fraction (dc).
! Coefficients for the asymmetry factor of ice plate
! particles (AR >= 1.0) with SMOOTH (ps) surfaces and 
! for their delta-transmission fraction (dp).
! See Eqs. (3.1), (3.3), (3.5), (3.6), and (2.2) in 
! Fu (2006).
! ********************************************************
   data cs /  1.349959E-1, -3.987320E-1, 7.938904E-1, &
	      1.115697E-1, -3.723287E-1, 8.030084E-1, &
	      9.853958E-2, -3.924784E-1, 8.513932E-1, &
	      5.557793E-2, -3.259404E-1, 8.692241E-1, &
	     -1.233493E-1,  4.429054E-2, 7.085850E-1, &
	      0.0,	   -1.726586E-1, 6.412701E-1/
   data dc /  1.0,	    0.0,	  &
	      9.843939E-1,  0.0,	  &
	      9.551336E-1, -1.212890E-3,  &
	      9.054886E-1, -2.444755E-3,  &
	      4.480282E-1, -4.749440E-3,  &
	      9.135134E-1, -1.695611E-2/
   data ps /  3.165543E-3,  1.140557E-1, 5.292852E-1, &
	      2.014810E-3,  1.143152E-1, 5.425909E-1, &
	      1.780838E-3,  1.143814E-1, 5.601598E-1, &
	      6.987734E-4,  1.071238E-1, 6.023407E-1, &
	     -1.882932E-2,  1.353873E-1, 6.473899E-1, &
	     -2.277872E-2,  1.914431E-1, 4.634944E-1/
   data dp /  1.0,	    0.0,	   &
	      1.0,	    0.0,	   &
	      1.0,	    0.0,	   &
	      9.546090E-1, -6.735732E-4,   &
	      5.298833E-1, -2.739150E-3,   &
	      9.625839E-1, -1.126258E-2/
	      
!--------------------------------------------------------	      
! ********************************************************
! 	dimension cr(3,6), pr(3,6)
! ********************************************************
!  Coefficients for the asymmetry factor of ice column
!  particles (AR <= 1.0) with ROUGH (cr) surfaces.
!  Coefficients for the asymmetry factor of ice plate
!  particles (AR >= 1.0) with ROUGH (pr) surfaces. 
!  See Eqs. (3.2), (3.4), and (2.2) in Fu (2006).
!  ********************************************************
  data cr /  1.425497E-1, -4.157560E-1, 7.386498E-1, &
	     1.164948E-1, -3.873595E-1, 7.512139E-1, &
	     1.077919E-1, -4.302394E-1, 8.230952E-1, &
	     5.926338E-2, -3.608777E-1, 8.529342E-1, &
	    -1.340814E-1,  4.670750E-2, 6.967419E-1, &
	     0.0,	  -2.408338E-1, 6.609769E-1/
  data pr /  1.659297E-2,  7.070839E-2, 4.653916E-1, &
	     1.478288E-2,  7.292324E-2, 4.816343E-1, &
	     1.549338E-2,  7.367233E-2, 5.044055E-1, &
	     1.351337E-2,  7.020179E-2, 5.555767E-1, &
	    -1.541111E-2,  1.246242E-1, 6.281019E-1, &
	    -5.930198E-3,  1.531992E-1, 4.098578E-1/

!------
	data bps / &
       1.3540265e-07,  9.9282217e-08, -7.3843168e-11,  3.3111862e-13, &
      -2.1458450e-06,  2.1984010e-05, -4.4225520e-09,  1.0711940e-11, &
       1.4027890e-04,  1.3919010e-03, -5.1005610e-06,  1.4032930e-08, &
       5.7801650e-03,  2.4420420e-03, -1.1985030e-05,  3.3878720e-08, &
       2.7122737e-01,  1.9809794e-03, -1.5071269e-05,  5.0103900e-08, &
       1.6215025e-01,  6.3734393e-03, -5.7740959e-05,  1.9109300e-07 /
	data cps / &
      7.4812728e-01,  9.5684492e-04, -1.1151708e-06, -8.1557303e-09, &
      7.5212480e-01,  1.1045100e-03, -2.9157100e-06, -1.3429900e-09, &
      7.5320460e-01,  1.8845180e-03, -9.7571460e-06,  2.2428270e-08, &
      7.7381780e-01,  2.2260760e-03, -1.4052790e-05,  3.7896870e-08, &
      8.7020490e-01,  1.6645530e-03, -1.4886030e-05,  4.9867270e-08, &
      7.4212060e-01,  5.2621900e-03, -5.0877550e-05,  1.7307870e-07 /
      data dps / &
      1.1572963e-01,  2.5648064e-04,  1.9131293e-06, -1.2460341e-08, &
      1.1360752e-01,  2.4156171e-04,  2.0185942e-06, -1.2876106e-08, &
      1.1241170e-01, -1.7635186e-07,  2.1499248e-06, -1.2949304e-08, &
      1.0855775e-01, -3.2496217e-04,  3.4207304e-06, -1.6247759e-08, &
      5.7783360e-02, -4.1158260e-04,  4.2361240e-06, -1.7204950e-08, &
      1.1367129e-01, -1.9711061e-03,  1.6078010e-05, -5.1736898e-08 /

real,save ,dimension(5,12)::apir1, bpir1, cpir1 ! small ice
real,save ,dimension(3,12):: apir
real,save ,dimension(4,12):: bpir,cpir

       data apir1 / &
      -2.005187e+00, 1.887870e+00, -2.394987e-01, 1.226004e-02, -2.176747e-04, &
      -1.221428e+00, 1.190519e+00, -1.081918e-01, 3.207774e-03, -7.790185e-06, &
      -5.522210e-01, 5.556264e-01, 1.350808e-02, -5.182503e-03,  1.854760e-04, &
      -2.411192e-01, 2.109769e-01, 7.588264e-02, -9.103300e-03,  2.678349e-04, &
      -1.485194e-02, 4.630892e-03, 8.989527e-02, -8.569112e-03,  2.290338e-04, &
       4.292661e-02, -7.619363e-04, 5.089112e-02, -4.101744e-03, 9.917537e-05, &
      -1.257657e-03, 3.840350e-01, -2.336758e-02, 5.263245e-04,  9.536367e-07, &
      -2.482977e-01, 5.149985e-01, -1.086854e-02, -1.909389e-03, 8.220600e-05, &
       1.130811e-01, -7.663294e-02, 9.961269e-02, -8.920452e-03, 2.325299e-04, &
       1.477471e-01, -1.276555e-01, 5.889066e-02, -3.637540e-03, 7.242738e-05, &
       2.778228e-02, 9.410452e-03, 7.771632e-03, -1.847559e-05, -7.178001e-06, &
       2.954018e-03, 1.254725e-01, -3.265442e-03, 2.270727e-04, -6.365789e-06 /
       data bpir1 / &
      -8.768658e-03, 8.493330e-02, -3.632126e-03, 6.987413e-05, 2.703965e-07,  &
      -7.762272e-03, 1.653825e-01, -1.242696e-02, 4.813596e-04,-6.987702e-06,  &
      -1.103846e-02, 1.880946e-01, -1.320780e-02, 4.530029e-04,-5.384886e-06,  &
      -1.240034e-02, 1.353184e-01, -6.773254e-03, 1.353446e-04, 4.783046e-07,  &
      -9.834148e-03, 1.045283e-01, -3.714625e-03, 9.185834e-06, 2.434297e-06,  &
      -4.989783e-03, 9.761852e-02, -3.464011e-03, 1.681863e-05, 1.990612e-06,  &
       5.524896e-02, 3.828618e-01, -4.868927e-02, 2.788080e-03,-5.893696e-05,  &
      -1.102297e-01, 4.983548e-01, -5.947312e-02, 3.147713e-03,-6.196981e-05,  &
      -3.705134e-02, 1.612865e-01, -4.132244e-03, -2.863781e-04,1.374847e-05,  &
       5.730367e-03, 3.433887e-02, 3.147511e-03, -3.044807e-04, 7.929481e-06,  &
       3.126666e-03, 3.533685e-02, 5.299923e-04, -6.735890e-05, 1.687872e-06,  &
       9.549627e-03, 1.140347e-01, 1.223725e-03, -4.282989e-04, 1.343652e-05 /
       data cpir1 /  &
      -1.592086e-01, 5.165795e-01, -8.889665e-02, 6.133364e-03, -1.466832e-04, &
      -2.780309e-01, 5.589181e-01, -9.294043e-02, 6.316572e-03, -1.501642e-04, &
      -4.146218e-01, 6.015844e-01, -9.714942e-02, 6.513667e-03, -1.539503e-04, &
      -4.644106e-01, 5.861063e-01, -9.087172e-02, 5.917403e-03, -1.371181e-04, &
      -4.848736e-01, 5.552414e-01, -8.183047e-02, 5.147920e-03, -1.164374e-04, &
      -5.056360e-01, 5.240870e-01, -7.278649e-02, 4.395703e-03, -9.639759e-05, &
      -4.991806e-01, 4.601579e-01, -5.805338e-02, 3.236112e-03, -6.615910e-05, &
      -4.382576e-01, 3.812485e-01, -4.268756e-02, 2.088357e-03, -3.689533e-05, &
      -3.094784e-01, 2.406058e-01, -1.477957e-02, 2.970087e-05,  1.421683e-05, &
      -9.731071e-02, 4.088258e-02, 2.106015e-02, -2.364895e-03,  6.892137e-05, &
       7.192725e-02, -8.649291e-02, 3.621089e-02, -2.888238e-03, 7.087982e-05, &
       6.792641e-02, -5.575384e-02, 1.319878e-02, -4.919461e-04, 8.543384e-07 /
       
 != Large dge      
              data apir / &
     		-2.308881e-03, 2.814002e+00, 1.072211e+00,  &
     		-2.465236e-03, 2.833187e+00,-4.227573e-01,  &
     		-3.034573e-03, 2.900043e+00,-1.849911e+00,  &
     		-4.936610e-03, 3.087764e+00,-3.884262e+00,  &
     		-8.178608e-03, 3.401245e+00,-8.812820e+00,  &
     		-8.372696e-03, 3.455018e+00,-1.516692e+01,  &
     		-1.691632e-03, 2.765756e+00,-8.331033e+00,  &
     		-4.159424e-03, 3.047325e+00,-5.061568e+00,  &
     		-9.524174e-03, 3.587742e+00,-1.068895e+01,  &
     		-1.334860e-02, 4.043808e+00,-2.171029e+01,  &
     		 3.325756e-03, 2.601360e+00,-1.909602e+01,  &
     		 4.919685e-03, 2.327741e+00,-1.390858e+01 / 
       	data bpir / &
       4.346482e-01, 1.721457e-02,-1.623227e-04, 5.561523e-07, &
       7.428957e-01, 1.279601e-02,-1.391803e-04, 5.180104e-07, &
       8.862434e-01, 1.226538e-02,-1.523076e-04, 6.000892e-07, &
       7.152274e-01, 1.621734e-02,-1.868544e-04, 7.078738e-07, &
       5.874323e-01, 1.876628e-02,-2.045834e-04, 7.510080e-07, &
       5.409536e-01, 1.949649e-02,-2.050908e-04, 7.364680e-07, &
       1.195515e+00, 3.350616e-03,-5.266996e-05, 2.233377e-07, &
       1.466481e+00,-2.129226e-03,-1.361630e-05, 1.193649e-07, &
       9.551440e-01, 1.309792e-02,-1.793694e-04, 7.313392e-07, &
       3.003701e-01, 2.051529e-02,-1.931684e-04, 6.583031e-07, &
       2.005578e-01, 2.132614e-02,-1.751052e-04, 5.355885e-07, &
       8.869787e-01, 2.118409e-02,-2.781429e-04, 1.094562e-06 /
       data cpir / &
       7.962716e-01, 3.003488e-03,-2.082376e-05, 5.366545e-08, &
       8.472918e-01, 2.559953e-03,-2.182660e-05, 6.879977e-08, &
       8.741665e-01, 2.455409e-03,-2.456935e-05, 8.641223e-08, &
       8.522816e-01, 2.523627e-03,-2.149196e-05, 6.685067e-08, &
       8.609604e-01, 2.200445e-03,-1.748105e-05, 5.176616e-08, &
       8.906280e-01, 1.903269e-03,-1.733552e-05, 5.855071e-08, &
       8.663385e-01, 2.797934e-03,-3.187011e-05, 1.217209e-07, &
       7.984021e-01, 3.977117e-03,-4.471984e-05, 1.694919e-07, &
       7.363466e-01, 4.798266e-03,-4.513292e-05, 1.525774e-07, &
       7.260484e-01, 2.664334e-03,-1.251136e-05, 2.243377e-08, &
       6.891414e-01, 6.192281e-03,-6.459514e-05, 2.436963e-07, &
       4.949276e-01, 1.186174e-02,-1.267629e-04, 4.603574e-07 /
     
 CONTAINS
 !======================================================================
subroutine asy_smooth_rough(itexture, ib18, par ,dge,  asy,fd ,omega_out)
integer ,intent(IN) :: itexture ,ib18
   real ,intent(IN)  :: dge ,par
   real ,intent(OUT) :: asy,fd
   real ,optional ,intent(OUT) :: omega_out
   real :: omega
integer,save :: ibmap(18)
data ibmap /10*1,4*2,3,4,5,6/
real fx,gx,ff ,y1,y2 
integer ib
real fw1,fw2,fw3

fw1 = dge
fw2 = dge*dge
fw3 = fw2*dge


ib = ibmap(ib18)

omega = 1.0 - ( bps(1,ib) + bps(2,ib) * fw1 +   &
                bps(3,ib) * fw2  + bps(4,ib) * fw3 )

if (present(omega_out) ) omega_out = omega

if( itexture == 1 ) then  !SMOOTH
	        fx = 0.5 / omega
	        if ( par .le. 1.0 ) then
	           y1 = par
	           y2 = y1 * y1
                   gx = cs(1,ib) * y2 + cs(2,ib) * y1 + cs(3,ib)
	           asy = fx + ( 1.0 - fx ) * gx
	           ff = 4.844102E-2*y2-1.156668E-1*y1+1.886680E-1
                   fd = ff * dc(1,ib) * exp ( dc(2,ib) * fw1 )
                else
	           y1 = alog ( par )
                   y2 = y1 * y1
                   gx = ps(1,ib) * y2 + ps(2,ib) * y1 + ps(3,ib)
                   asy = fx + ( 1.0 - fx ) * gx
	           ff = -1.650551E-4*y2+9.739614E-2*y1+1.060183E-1
                   fd = ff * dp(1,ib) * exp ( dp(2,ib) * fw1 )
	        endif !END SMOOTH

elseif ( itexture == 2 ) then  !ROUGH
 	        fx = 0.5 / omega
	        if ( par .le. 1.0 ) then
	           y1 = par
	           y2 = y1 * y1
                   gx = cr(1,ib) * y2 + cr(2,ib) * y1 + cr(3,ib)
	           asy = fx + ( 1.0 - fx ) * gx
                else
	           y1 = alog ( par )
                   y2 = y1 * y1
                   gx = pr(1,ib) * y2 + pr(2,ib) * y1 + pr(3,ib)
                   asy = fx + ( 1.0 - fx ) * gx
	        endif !END ROUGH
                fd = 0.0
		
else !! Old Fu method
	        asy = cps(1,ib) + cps(2,ib) * fw1 + &
                      cps(3,ib) * fw2 + cps(4,ib) * fw3
		     
	        fd =  dps(1,ib) + dps(2,ib) * fw1 + &
                      dps(3,ib) * fw2 + dps(4,ib) * fw3

endif
		
end subroutine asy_smooth_rough


 !======================================================================
subroutine ir_small_large(ibr, dge,iwc, betae , betaa, asy )
integer , intent(IN)::ibr
real , intent(IN):: dge,iwc

real , intent(out):: betae , betaa, asy
real fw1,fw2,fw3,fw4
fw1 = dge
fw2 = dge*dge
fw3 = fw2*dge
fw4 = fw3*dge
   if ( dge < 15 ) then
               betae = iwc / fw1 *                       &
	     ( apir1(1,ibr) + apir1(2,ibr) * fw1 +	 &
	       apir1(3,ibr) * fw2 + apir1(4,ibr) * fw3 + &
	       apir1(5,ibr) * fw4 )
	       
	     betaa = iwc / fw1 *                         &
	     ( bpir1(1,ibr) + bpir1(2,ibr) * fw1 +	 &
	       bpir1(3,ibr) * fw2 + bpir1(4,ibr) * fw3 + &
	       bpir1(5,ibr) * fw4 )
	       
	     asy = cpir1(1,ibr) + cpir1(2,ibr) * fw1 +   &
	       cpir1(3,ibr) * fw2 + cpir1(4,ibr) * fw3 + &
	       cpir1(5,ibr) * fw4
    else ! LARGE
    
    	 betae = iwc * ( apir(1,ibr) + 			  &
 			  apir(2,ibr) / fw1 + apir(3,ibr) / fw2 )

 	 betaa = iwc / fw1 * ( bpir(1,ibr) + bpir(2,ibr) *	  &
		 fw1 + bpir(3,ibr) * fw2 + bpir(4,ibr) * fw3 )

 	 asy = cpir(1,ibr) + cpir(2,ibr) * fw1 +  		 &
	                     cpir(3,ibr) * fw2 + cpir(4,ibr) * fw3
    endif	       
	       
	       
end subroutine ir_small_large
!==========================================================================	

END MODULE AR_ASY_FU
!==========================================================================	
